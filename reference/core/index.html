
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A lightweight framework for researchers to fast-prototype advanced agentic systems.">
      
      
      
        <link rel="canonical" href="https://example.com/reference/core/">
      
      
        <link rel="prev" href="../../advanced/program-synthesis/">
      
      
        <link rel="next" href="../providers/">
      
      
        
      
      
      <link rel="icon" href="../../assets/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>lllm.core - LLLM</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="deep-purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#core-api-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="LLLM" class="md-header__button md-logo" aria-label="LLLM" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            LLLM
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              lllm.core
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="deep-purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="deep-purple"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="LLLM" class="md-nav__button md-logo" aria-label="LLLM" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    LLLM
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Core Concepts
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Core Concepts
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Agents
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/prompts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Prompts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core/providers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Providers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Advanced
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Advanced
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../advanced/neuro-symbolic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Neuro-Symbolic AI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../advanced/program-synthesis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Program Synthesis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    lllm.core
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    lllm.core
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#agent" class="md-nav__link">
    <span class="md-ellipsis">
      
        Agent
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lllm.core.agent.Agent" class="md-nav__link">
    <span class="md-ellipsis">
      
        Agent
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lllm.core.agent.Agent.max_llm_recall" class="md-nav__link">
    <span class="md-ellipsis">
      
        max_llm_recall
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lllm.core.agent.Agent.call" class="md-nav__link">
    <span class="md-ellipsis">
      
        call
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agentbase" class="md-nav__link">
    <span class="md-ellipsis">
      
        AgentBase
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lllm.core.agent.AgentBase" class="md-nav__link">
    <span class="md-ellipsis">
      
        AgentBase
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dialog" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dialog
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lllm.core.dialog.Dialog" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dialog
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#models" class="md-nav__link">
    <span class="md-ellipsis">
      
        Models
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lllm.core.models.Message" class="md-nav__link">
    <span class="md-ellipsis">
      
        Message
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lllm.core.models.Prompt" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prompt
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../providers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    lllm.providers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proxies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    lllm.proxies
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#agent" class="md-nav__link">
    <span class="md-ellipsis">
      
        Agent
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lllm.core.agent.Agent" class="md-nav__link">
    <span class="md-ellipsis">
      
        Agent
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lllm.core.agent.Agent.max_llm_recall" class="md-nav__link">
    <span class="md-ellipsis">
      
        max_llm_recall
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lllm.core.agent.Agent.call" class="md-nav__link">
    <span class="md-ellipsis">
      
        call
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agentbase" class="md-nav__link">
    <span class="md-ellipsis">
      
        AgentBase
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lllm.core.agent.AgentBase" class="md-nav__link">
    <span class="md-ellipsis">
      
        AgentBase
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dialog" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dialog
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lllm.core.dialog.Dialog" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dialog
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#models" class="md-nav__link">
    <span class="md-ellipsis">
      
        Models
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lllm.core.models.Message" class="md-nav__link">
    <span class="md-ellipsis">
      
        Message
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lllm.core.models.Prompt" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prompt
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="core-api-reference">Core API Reference</h1>
<h2 id="agent">Agent</h2>


<div class="doc doc-object doc-class">



<h2 id="lllm.core.agent.Agent" class="doc doc-heading">
            <code>lllm.core.agent.Agent</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents first">










              <details class="mkdocstrings-source">
                <summary>Source code in <code>lllm/core/agent.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="k">class</span><span class="w"> </span><span class="nc">Agent</span><span class="p">:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="c1"># the role of the agent, or a name of the agent</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Prompt</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="c1"># the latest snapshot of a model</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="n">llm_provider</span><span class="p">:</span> <span class="n">BaseProvider</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="n">log_base</span><span class="p">:</span> <span class="n">ReplayableLogBase</span>   
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="n">api_type</span><span class="p">:</span> <span class="n">APITypes</span> <span class="o">=</span> <span class="n">APITypes</span><span class="o">.</span><span class="n">COMPLETION</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="n">model_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span> <span class="c1"># additional args, like temperature, seed, etc.</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="n">max_exception_retry</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="n">max_interrupt_times</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="n">max_llm_recall</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">    Represents a single LLM agent with a specific role and capabilities.</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">    Attributes:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">        name (str): The name or role of the agent (e.g., &#39;assistant&#39;, &#39;coder&#39;).</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">        system_prompt (Prompt): The system prompt defining the agent&#39;s persona.</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">        model (str): The model identifier (e.g., &#39;gpt-4o&#39;).</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">        llm_provider (BaseProvider): The provider instance for LLM calls.</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">        log_base (ReplayableLogBase): Logger for recording interactions.</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">        model_args (Dict[str, Any]): Additional model arguments (temp, top_p, etc.).</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">        max_exception_retry (int): Max retries for agent exceptions.</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">        max_interrupt_times (int): Max consecutive tool call interrupts.</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">        max_llm_recall (int): Max retries for LLM API errors.</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_card</span> <span class="o">=</span> <span class="n">find_model_card</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_card</span><span class="o">.</span><span class="n">check_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_args</span><span class="p">)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_card</span><span class="o">.</span><span class="n">latest_snapshot</span><span class="o">.</span><span class="n">name</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">reload_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">:</span> <span class="n">Prompt</span><span class="p">):</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span> <span class="o">=</span> <span class="n">system_prompt</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>    <span class="c1"># initialize the dialog</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">init_dialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">session_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dialog</span><span class="p">:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="n">prompt_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">prompt_args</span><span class="p">)</span> <span class="k">if</span> <span class="n">prompt_args</span> <span class="k">else</span> <span class="p">{}</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="k">if</span> <span class="n">session_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>            <span class="n">session_name</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())[:</span><span class="mi">6</span><span class="p">]</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="n">system_message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>            <span class="n">role</span><span class="o">=</span><span class="n">Roles</span><span class="o">.</span><span class="n">SYSTEM</span><span class="p">,</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>            <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">(</span><span class="o">**</span><span class="n">prompt_args</span><span class="p">),</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>            <span class="n">creator</span><span class="o">=</span><span class="s1">&#39;system&#39;</span><span class="p">,</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="p">)</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="k">return</span> <span class="n">Dialog</span><span class="p">(</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="p">[</span><span class="n">system_message</span><span class="p">],</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">log_base</span><span class="p">,</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="n">session_name</span><span class="p">,</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="n">top_prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">,</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="p">)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="c1"># send a message to the dialog manually</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">send_message</span><span class="p">(</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="n">dialog</span><span class="p">:</span> <span class="n">Dialog</span><span class="p">,</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="n">prompt</span><span class="p">:</span> <span class="n">Prompt</span><span class="p">,</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="n">prompt_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="n">creator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;internal&#39;</span><span class="p">,</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="n">extra</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="n">role</span><span class="p">:</span> <span class="n">Roles</span> <span class="o">=</span> <span class="n">Roles</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>    <span class="p">):</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="n">prompt_payload</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">prompt_args</span><span class="p">)</span> <span class="k">if</span> <span class="n">prompt_args</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="n">extra_payload</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span> <span class="k">if</span> <span class="n">extra</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="k">return</span> <span class="n">dialog</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">prompt_payload</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="n">creator</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">extra_payload</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>    <span class="c1"># it performs the &quot;Agent Call&quot;</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call</span><span class="p">(</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="n">dialog</span><span class="p">:</span> <span class="n">Dialog</span><span class="p">,</span>  <span class="c1"># it assumes the prompt is already loaded into the dialog as the top prompt by send_message</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="n">extra</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># for tracking additional information, such as frontend replay info</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># for tracking additional information, such as frontend replay info</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="n">parser_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Message</span><span class="p">,</span> <span class="n">Dialog</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionCall</span><span class="p">]]:</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">        Executes the agent loop, handling LLM calls, tool execution, and interrupts.</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">            dialog (Dialog): The current dialog state.</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">            extra (Dict[str, Any], optional): Extra metadata for the call.</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">            args (Dict[str, Any], optional): Additional arguments for the prompt.</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">            parser_args (Dict[str, Any], optional): Arguments for the output parser.</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="sd">            Tuple[Message, Dialog, List[FunctionCall]]: The final response message, the updated dialog, and a list of executed function calls.</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="sd">            ValueError: If the agent fails to produce a valid response after retries.</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="n">extra</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span> <span class="k">if</span> <span class="n">extra</span> <span class="k">else</span> <span class="p">{}</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="p">{}</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="n">parser_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">parser_args</span><span class="p">)</span> <span class="k">if</span> <span class="n">parser_args</span> <span class="k">else</span> <span class="p">{}</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="c1"># Prompt: a function maps prompt args and dialog into the expected output </span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="n">current_prompt</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">top_prompt</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="n">interrupts</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_interrupt_times</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_interrupt_times</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># +1 for the final response</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>            <span class="n">llm_recall</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_llm_recall</span> 
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>            <span class="n">exception_retry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_exception_retry</span> 
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>            <span class="n">working_dialog</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span> <span class="c1"># make a copy of the dialog, truncate all excception handling dialogs</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span> <span class="c1"># ensure the response is no exception</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>                <span class="n">execution_attempts</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>                    <span class="n">_model_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>                    <span class="n">_model_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_provider</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>                        <span class="n">working_dialog</span><span class="p">,</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>                        <span class="n">current_prompt</span><span class="p">,</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                        <span class="n">_model_args</span><span class="p">,</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                        <span class="n">parser_args</span><span class="o">=</span><span class="n">parser_args</span><span class="p">,</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                        <span class="n">responder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                        <span class="n">extra</span><span class="o">=</span><span class="n">extra</span><span class="p">,</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>                        <span class="n">api_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api_type</span><span class="p">,</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>                    <span class="p">)</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                    <span class="n">working_dialog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> 
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">execution_errors</span> <span class="o">!=</span> <span class="p">[]:</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>                        <span class="n">execution_attempts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>                        <span class="k">raise</span> <span class="n">AgentException</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">error_message</span><span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>                    <span class="k">else</span><span class="p">:</span> 
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>                        <span class="k">break</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>                <span class="k">except</span> <span class="n">AgentException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># handle the exception from the agent</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>                    <span class="k">if</span> <span class="n">exception_retry</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>                        <span class="n">exception_retry</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>                        <span class="n">U</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> is handling an exception </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">, retry times: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_exception_retry</span><span class="o">-</span><span class="n">exception_retry</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_exception_retry</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>                        <span class="n">working_dialog</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">current_prompt</span><span class="o">.</span><span class="n">exception_handler</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;error_message&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span> <span class="n">creator</span><span class="o">=</span><span class="s1">&#39;exception&#39;</span><span class="p">)</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>                        <span class="n">current_prompt</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">top_prompt</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>                        <span class="k">continue</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>                        <span class="k">raise</span> <span class="n">e</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># handle the exception from the LLM</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>                    <span class="c1"># Simplified error handling for now</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>                    <span class="n">wait_time</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">*</span><span class="mi">15</span><span class="o">+</span><span class="mi">1</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>                    <span class="k">if</span> <span class="n">U</span><span class="o">.</span><span class="n">is_openai_rate_limit_error</span><span class="p">(</span><span class="n">e</span><span class="p">):</span> <span class="c1"># for safe</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait_time</span><span class="p">)</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>                        <span class="k">if</span> <span class="n">llm_recall</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                            <span class="n">llm_recall</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># wait for a while before retrying</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                            <span class="k">continue</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>                        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>                            <span class="k">raise</span> <span class="n">e</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>            <span class="n">response</span><span class="o">.</span><span class="n">execution_attempts</span> <span class="o">=</span> <span class="n">execution_attempts</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>            <span class="n">dialog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="c1"># update the dialog state</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>            <span class="c1"># now handle the interruption</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">is_function_call</span><span class="p">:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>                <span class="n">_func_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">func_call</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">func_call</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">function_calls</span><span class="p">]</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>                <span class="n">U</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> is calling function </span><span class="si">{</span><span class="n">_func_names</span><span class="si">}</span><span class="s1">, interrupt times: </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_interrupt_times</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>                <span class="c1"># handle the function call</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                <span class="k">for</span> <span class="n">function_call</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">function_calls</span><span class="p">:</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                    <span class="k">if</span> <span class="n">function_call</span><span class="o">.</span><span class="n">is_repeated</span><span class="p">(</span><span class="n">interrupts</span><span class="p">):</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                        <span class="n">result_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;The function </span><span class="si">{</span><span class="n">function_call</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> with identical arguments </span><span class="si">{</span><span class="n">function_call</span><span class="o">.</span><span class="n">arguments</span><span class="si">}</span><span class="s1"> has been called earlier, please check the previous results and do not call it again. If you do not need to call more functions, just stop calling and provide the final response.&#39;</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> is calling function </span><span class="si">{</span><span class="n">function_call</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> with arguments </span><span class="si">{</span><span class="n">function_call</span><span class="o">.</span><span class="n">arguments</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>                        <span class="k">if</span> <span class="n">function_call</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_prompt</span><span class="o">.</span><span class="n">functions</span><span class="p">:</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>                            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Function &#39;</span><span class="si">{</span><span class="n">function_call</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not registered on prompt &#39;</span><span class="si">{</span><span class="n">current_prompt</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>                        <span class="n">function</span> <span class="o">=</span> <span class="n">current_prompt</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="n">function_call</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>                        <span class="n">function_call</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">function_call</span><span class="p">)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>                        <span class="n">result_str</span> <span class="o">=</span> <span class="n">function_call</span><span class="o">.</span><span class="n">result_str</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>                        <span class="n">interrupts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">function_call</span><span class="p">)</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>                    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">api_type</span> <span class="o">==</span> <span class="n">APITypes</span><span class="o">.</span><span class="n">RESPONSE</span><span class="p">:</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>                        <span class="n">interrupt_role</span> <span class="o">=</span> <span class="n">Roles</span><span class="o">.</span><span class="n">USER</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>                        <span class="n">interrupt_role</span> <span class="o">=</span> <span class="n">Roles</span><span class="o">.</span><span class="n">TOOL</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>                    <span class="n">dialog</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>                        <span class="n">current_prompt</span><span class="o">.</span><span class="n">interrupt_handler</span><span class="p">,</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>                        <span class="p">{</span><span class="s1">&#39;call_results&#39;</span><span class="p">:</span> <span class="n">result_str</span><span class="p">},</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>                        <span class="n">role</span><span class="o">=</span><span class="n">interrupt_role</span><span class="p">,</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>                        <span class="n">creator</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">,</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>                        <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;tool_call_id&#39;</span><span class="p">:</span> <span class="n">function_call</span><span class="o">.</span><span class="n">id</span><span class="p">},</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>                    <span class="p">)</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_interrupt_times</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>                    <span class="n">dialog</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">current_prompt</span><span class="o">.</span><span class="n">interrupt_handler_final</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">Roles</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>                <span class="n">current_prompt</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">top_prompt</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>            <span class="k">else</span><span class="p">:</span> <span class="c1"># the response is not a function call, it is the final response</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>   
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>                    <span class="n">U</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> stopped calling functions, total interrupt times: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_interrupt_times</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>                <span class="k">return</span> <span class="n">response</span><span class="p">,</span> <span class="n">dialog</span><span class="p">,</span> <span class="n">interrupts</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Failed to call the agent&#39;</span><span class="p">)</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>    <span class="c1"># a special agent call for classification</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_classify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialog</span><span class="p">:</span> <span class="n">Dialog</span><span class="p">,</span> <span class="n">classes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">classifier_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="n">_</span><span class="p">,</span> <span class="n">dialog</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">dialog</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">classifier_args</span><span class="p">)</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">tail</span><span class="o">.</span><span class="n">raw_response</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>        <span class="n">choice</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>        <span class="n">logprobs</span> <span class="o">=</span> <span class="n">choice</span><span class="o">.</span><span class="n">logprobs</span><span class="o">.</span><span class="n">content</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">logprobs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>            <span class="k">raise</span> <span class="n">ClassificationError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed to classify the proposition, not only one token (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">logprobs</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>        <span class="n">chosen_token_data</span> <span class="o">=</span> <span class="n">choice</span><span class="o">.</span><span class="n">logprobs</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>        <span class="n">top_probs</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>        <span class="k">for</span> <span class="n">top_logprob_entry</span> <span class="ow">in</span> <span class="n">chosen_token_data</span><span class="o">.</span><span class="n">top_logprobs</span><span class="p">:</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>            <span class="n">token</span> <span class="o">=</span> <span class="n">top_logprob_entry</span><span class="o">.</span><span class="n">token</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>            <span class="n">prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">top_logprob_entry</span><span class="o">.</span><span class="n">logprob</span><span class="p">)</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>            <span class="n">top_probs</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="n">prob</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>        <span class="n">U</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span><span class="n">top_probs</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>            <span class="k">if</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">top_probs</span><span class="p">:</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2"> not found in the top logprobs&quot;</span><span class="p">)</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>        <span class="k">if</span> <span class="n">errors</span> <span class="o">!=</span> <span class="p">[]:</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>            <span class="k">raise</span> <span class="n">ClassificationError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed to classify the proposition:</span><span class="se">\n</span><span class="si">{</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>        <span class="k">return</span> <span class="n">top_probs</span><span class="p">,</span> <span class="n">dialog</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">classify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialog</span><span class="p">:</span> <span class="n">Dialog</span><span class="p">,</span> <span class="n">classes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">classifier_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">strength</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="c1"># binary classification by default</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>        <span class="n">_classifier_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_card</span><span class="o">.</span><span class="n">make_classifier</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">strength</span><span class="p">)</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>        <span class="k">if</span> <span class="n">classifier_prompt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>            <span class="n">_classes</span> <span class="o">=</span> <span class="s1">&#39; or &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">])</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>            <span class="n">classifier_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Please respond with one and only one word from </span><span class="si">{</span><span class="n">_classes</span><span class="si">}</span><span class="s2">.&quot;</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>        <span class="n">dialog</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">classifier_prompt</span><span class="p">)</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="n">_dialog</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>        <span class="n">llm_recall</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_llm_recall</span> 
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="n">exception_retry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_exception_retry</span> 
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>                <span class="n">top_probs</span><span class="p">,</span> <span class="n">_dialog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classify</span><span class="p">(</span><span class="n">_dialog</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">_classifier_args</span><span class="p">)</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>                <span class="n">dialog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_dialog</span><span class="o">.</span><span class="n">tail</span><span class="p">)</span> <span class="c1"># truncate the error handlings</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>                <span class="k">return</span> <span class="n">top_probs</span><span class="p">,</span> <span class="n">dialog</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>            <span class="k">except</span> <span class="n">ClassificationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>                <span class="k">if</span> <span class="n">exception_retry</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>                    <span class="n">_dialog</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Please respond with one and only one word from </span><span class="si">{</span><span class="n">classes</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>                    <span class="n">exception_retry</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="se">\n</span><span class="s1">Retrying... times: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_exception_retry</span><span class="o">-</span><span class="n">exception_retry</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_exception_retry</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>                    <span class="k">raise</span> <span class="n">e</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>                <span class="k">if</span> <span class="n">llm_recall</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>                    <span class="n">llm_recall</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>                    <span class="k">raise</span> <span class="n">e</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="lllm.core.agent.Agent.max_llm_recall" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">max_llm_recall</span> <span class="o">=</span> <span class="mi">0</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Represents a single LLM agent with a specific role and capabilities.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="lllm.core.agent.Agent.max_llm_recall.name">name</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name or role of the agent (e.g., 'assistant', 'coder').</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="lllm.core.agent.Agent.max_llm_recall.system_prompt">system_prompt</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="lllm.core.models.Prompt" href="#lllm.core.models.Prompt">Prompt</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The system prompt defining the agent's persona.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="lllm.core.agent.Agent.max_llm_recall.model">model</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The model identifier (e.g., 'gpt-4o').</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="lllm.core.agent.Agent.max_llm_recall.llm_provider">llm_provider</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="lllm.providers.base.BaseProvider" href="../providers/#lllm.providers.base.BaseProvider">BaseProvider</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The provider instance for LLM calls.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="lllm.core.agent.Agent.max_llm_recall.log_base">log_base</span></code></td>
            <td>
                  <code><span title="lllm.core.log.ReplayableLogBase">ReplayableLogBase</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Logger for recording interactions.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="lllm.core.agent.Agent.max_llm_recall.model_args">model_args</span></code></td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional model arguments (temp, top_p, etc.).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="lllm.core.agent.Agent.max_llm_recall.max_exception_retry">max_exception_retry</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Max retries for agent exceptions.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="lllm.core.agent.Agent.max_llm_recall.max_interrupt_times">max_interrupt_times</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Max consecutive tool call interrupts.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="lllm.core.agent.Agent.max_llm_recall.max_llm_recall">max_llm_recall</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Max retries for LLM API errors.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

    </div>

</div>




<div class="doc doc-object doc-function">


<h3 id="lllm.core.agent.Agent.call" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">call</span><span class="p">(</span><span class="n">dialog</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parser_args</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Executes the agent loop, handling LLM calls, tool execution, and interrupts.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>dialog</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="lllm.core.dialog.Dialog


  
      dataclass
  " href="#lllm.core.dialog.Dialog">Dialog</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current dialog state.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>extra</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Extra metadata for the call.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>args</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments for the prompt.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>parser_args</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Arguments for the output parser.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<a class="autorefs autorefs-internal" title="lllm.core.models.Message" href="#lllm.core.models.Message">Message</a>, <a class="autorefs autorefs-internal" title="lllm.core.dialog.Dialog


  
      dataclass
  " href="#lllm.core.dialog.Dialog">Dialog</a>, <span title="typing.List">List</span>[<span title="lllm.core.models.FunctionCall">FunctionCall</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple[Message, Dialog, List[FunctionCall]]: The final response message, the updated dialog, and a list of executed function calls.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the agent fails to produce a valid response after retries.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>lllm/core/agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="k">def</span><span class="w"> </span><span class="nf">call</span><span class="p">(</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>    <span class="n">dialog</span><span class="p">:</span> <span class="n">Dialog</span><span class="p">,</span>  <span class="c1"># it assumes the prompt is already loaded into the dialog as the top prompt by send_message</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="n">extra</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># for tracking additional information, such as frontend replay info</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># for tracking additional information, such as frontend replay info</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="n">parser_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Message</span><span class="p">,</span> <span class="n">Dialog</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionCall</span><span class="p">]]:</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">    Executes the agent loop, handling LLM calls, tool execution, and interrupts.</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">        dialog (Dialog): The current dialog state.</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">        extra (Dict[str, Any], optional): Extra metadata for the call.</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">        args (Dict[str, Any], optional): Additional arguments for the prompt.</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">        parser_args (Dict[str, Any], optional): Arguments for the output parser.</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="sd">        Tuple[Message, Dialog, List[FunctionCall]]: The final response message, the updated dialog, and a list of executed function calls.</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="sd">        ValueError: If the agent fails to produce a valid response after retries.</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="n">extra</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span> <span class="k">if</span> <span class="n">extra</span> <span class="k">else</span> <span class="p">{}</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>    <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="p">{}</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="n">parser_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">parser_args</span><span class="p">)</span> <span class="k">if</span> <span class="n">parser_args</span> <span class="k">else</span> <span class="p">{}</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="c1"># Prompt: a function maps prompt args and dialog into the expected output </span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>    <span class="n">current_prompt</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">top_prompt</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="n">interrupts</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_interrupt_times</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_interrupt_times</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># +1 for the final response</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="n">llm_recall</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_llm_recall</span> 
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="n">exception_retry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_exception_retry</span> 
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="n">working_dialog</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span> <span class="c1"># make a copy of the dialog, truncate all excception handling dialogs</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span> <span class="c1"># ensure the response is no exception</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="n">execution_attempts</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>                <span class="n">_model_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>                <span class="n">_model_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_provider</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>                    <span class="n">working_dialog</span><span class="p">,</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>                    <span class="n">current_prompt</span><span class="p">,</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                    <span class="n">_model_args</span><span class="p">,</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                    <span class="n">parser_args</span><span class="o">=</span><span class="n">parser_args</span><span class="p">,</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                    <span class="n">responder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                    <span class="n">extra</span><span class="o">=</span><span class="n">extra</span><span class="p">,</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>                    <span class="n">api_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api_type</span><span class="p">,</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>                <span class="p">)</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                <span class="n">working_dialog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> 
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">execution_errors</span> <span class="o">!=</span> <span class="p">[]:</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>                    <span class="n">execution_attempts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>                    <span class="k">raise</span> <span class="n">AgentException</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">error_message</span><span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>                <span class="k">else</span><span class="p">:</span> 
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>                    <span class="k">break</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>            <span class="k">except</span> <span class="n">AgentException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># handle the exception from the agent</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>                <span class="k">if</span> <span class="n">exception_retry</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>                    <span class="n">exception_retry</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>                    <span class="n">U</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> is handling an exception </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">, retry times: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_exception_retry</span><span class="o">-</span><span class="n">exception_retry</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_exception_retry</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>                    <span class="n">working_dialog</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">current_prompt</span><span class="o">.</span><span class="n">exception_handler</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;error_message&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span> <span class="n">creator</span><span class="o">=</span><span class="s1">&#39;exception&#39;</span><span class="p">)</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>                    <span class="n">current_prompt</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">top_prompt</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>                    <span class="k">raise</span> <span class="n">e</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># handle the exception from the LLM</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>                <span class="c1"># Simplified error handling for now</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>                <span class="n">wait_time</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">*</span><span class="mi">15</span><span class="o">+</span><span class="mi">1</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>                <span class="k">if</span> <span class="n">U</span><span class="o">.</span><span class="n">is_openai_rate_limit_error</span><span class="p">(</span><span class="n">e</span><span class="p">):</span> <span class="c1"># for safe</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait_time</span><span class="p">)</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>                    <span class="k">if</span> <span class="n">llm_recall</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                        <span class="n">llm_recall</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># wait for a while before retrying</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                        <span class="k">continue</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>                        <span class="k">raise</span> <span class="n">e</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>        <span class="n">response</span><span class="o">.</span><span class="n">execution_attempts</span> <span class="o">=</span> <span class="n">execution_attempts</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="n">dialog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="c1"># update the dialog state</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="c1"># now handle the interruption</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">is_function_call</span><span class="p">:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>            <span class="n">_func_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">func_call</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">func_call</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">function_calls</span><span class="p">]</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>            <span class="n">U</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> is calling function </span><span class="si">{</span><span class="n">_func_names</span><span class="si">}</span><span class="s1">, interrupt times: </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_interrupt_times</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>            <span class="c1"># handle the function call</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>            <span class="k">for</span> <span class="n">function_call</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">function_calls</span><span class="p">:</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                <span class="k">if</span> <span class="n">function_call</span><span class="o">.</span><span class="n">is_repeated</span><span class="p">(</span><span class="n">interrupts</span><span class="p">):</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                    <span class="n">result_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;The function </span><span class="si">{</span><span class="n">function_call</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> with identical arguments </span><span class="si">{</span><span class="n">function_call</span><span class="o">.</span><span class="n">arguments</span><span class="si">}</span><span class="s1"> has been called earlier, please check the previous results and do not call it again. If you do not need to call more functions, just stop calling and provide the final response.&#39;</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> is calling function </span><span class="si">{</span><span class="n">function_call</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> with arguments </span><span class="si">{</span><span class="n">function_call</span><span class="o">.</span><span class="n">arguments</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>                    <span class="k">if</span> <span class="n">function_call</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_prompt</span><span class="o">.</span><span class="n">functions</span><span class="p">:</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>                        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Function &#39;</span><span class="si">{</span><span class="n">function_call</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not registered on prompt &#39;</span><span class="si">{</span><span class="n">current_prompt</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>                    <span class="n">function</span> <span class="o">=</span> <span class="n">current_prompt</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="n">function_call</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>                    <span class="n">function_call</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">function_call</span><span class="p">)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>                    <span class="n">result_str</span> <span class="o">=</span> <span class="n">function_call</span><span class="o">.</span><span class="n">result_str</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>                    <span class="n">interrupts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">function_call</span><span class="p">)</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">api_type</span> <span class="o">==</span> <span class="n">APITypes</span><span class="o">.</span><span class="n">RESPONSE</span><span class="p">:</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>                    <span class="n">interrupt_role</span> <span class="o">=</span> <span class="n">Roles</span><span class="o">.</span><span class="n">USER</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>                    <span class="n">interrupt_role</span> <span class="o">=</span> <span class="n">Roles</span><span class="o">.</span><span class="n">TOOL</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>                <span class="n">dialog</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>                    <span class="n">current_prompt</span><span class="o">.</span><span class="n">interrupt_handler</span><span class="p">,</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>                    <span class="p">{</span><span class="s1">&#39;call_results&#39;</span><span class="p">:</span> <span class="n">result_str</span><span class="p">},</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>                    <span class="n">role</span><span class="o">=</span><span class="n">interrupt_role</span><span class="p">,</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>                    <span class="n">creator</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">,</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>                    <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;tool_call_id&#39;</span><span class="p">:</span> <span class="n">function_call</span><span class="o">.</span><span class="n">id</span><span class="p">},</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>                <span class="p">)</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_interrupt_times</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>                <span class="n">dialog</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">current_prompt</span><span class="o">.</span><span class="n">interrupt_handler_final</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="n">Roles</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>            <span class="n">current_prompt</span> <span class="o">=</span> <span class="n">dialog</span><span class="o">.</span><span class="n">top_prompt</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="k">else</span><span class="p">:</span> <span class="c1"># the response is not a function call, it is the final response</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>   
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>                <span class="n">U</span><span class="o">.</span><span class="n">cprint</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> stopped calling functions, total interrupt times: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_interrupt_times</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>            <span class="k">return</span> <span class="n">response</span><span class="p">,</span> <span class="n">dialog</span><span class="p">,</span> <span class="n">interrupts</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Failed to call the agent&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="agentbase">AgentBase</h2>


<div class="doc doc-object doc-class">



<h2 id="lllm.core.agent.AgentBase" class="doc doc-heading">
            <code>lllm.core.agent.AgentBase</code>


</h2>


    <div class="doc doc-contents first">










              <details class="mkdocstrings-source">
                <summary>Source code in <code>lllm/core/agent.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-291" name="__codelineno-0-291"></a><span class="k">class</span><span class="w"> </span><span class="nc">AgentBase</span><span class="p">:</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>    <span class="n">agent_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Enum</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>    <span class="n">agent_group</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>    <span class="n">is_async</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">register</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>        <span class="k">if</span> <span class="n">register</span><span class="p">:</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>            <span class="n">register_agent_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">ckpt_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stream</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>        <span class="n">auto_discover_if_enabled</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;auto_discover&quot;</span><span class="p">))</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>        <span class="k">if</span> <span class="n">stream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>            <span class="n">stream</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">PrintSystem</span><span class="p">()</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Agent group is not set for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">agent_type</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>        <span class="n">_agent_configs</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;agent_configs&#39;</span><span class="p">]</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agent_configs</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>        <span class="k">for</span> <span class="n">agent_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_group</span><span class="p">:</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>            <span class="k">assert</span> <span class="n">agent_name</span> <span class="ow">in</span> <span class="n">_agent_configs</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Agent </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2"> not found in agent configs&quot;</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">agent_configs</span><span class="p">[</span><span class="n">agent_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_agent_configs</span><span class="p">[</span><span class="n">agent_name</span><span class="p">]</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="o">=</span> <span class="n">stream</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_stream_backup</span> <span class="o">=</span> <span class="n">stream</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">st</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ckpt_dir</span> <span class="o">=</span> <span class="n">ckpt_dir</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_log_base</span> <span class="o">=</span> <span class="n">build_log_base</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agents</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>        <span class="c1"># Initialize Provider via registry</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">llm_provider</span> <span class="o">=</span> <span class="n">build_provider</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>        <span class="k">for</span> <span class="n">agent_name</span><span class="p">,</span> <span class="n">model_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_configs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>            <span class="n">model_config</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>            <span class="n">model_name</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">)</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">find_model_card</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>            <span class="n">system_prompt_path</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;system_prompt_path&#39;</span><span class="p">)</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>            <span class="n">api_type_value</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;api_type&#39;</span><span class="p">,</span> <span class="n">APITypes</span><span class="o">.</span><span class="n">COMPLETION</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">api_type_value</span><span class="p">,</span> <span class="n">APITypes</span><span class="p">):</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>                <span class="n">api_type</span> <span class="o">=</span> <span class="n">api_type_value</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>                <span class="n">api_type</span> <span class="o">=</span> <span class="n">APITypes</span><span class="p">(</span><span class="n">api_type_value</span><span class="p">)</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>            <span class="c1"># We assume PROMPT_REGISTRY is available globally or passed. </span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>            <span class="c1"># This is a bit of a dependency issue. </span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>            <span class="c1"># Ideally, prompts should be loaded/registered before Agent initialization.</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>            <span class="c1"># For now, we&#39;ll assume the user registers prompts before creating agents.</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">lllm.core.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">PROMPT_REGISTRY</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">agents</span><span class="p">[</span><span class="n">agent_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>                <span class="n">name</span><span class="o">=</span><span class="n">agent_name</span><span class="p">,</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>                <span class="n">system_prompt</span><span class="o">=</span><span class="n">PROMPT_REGISTRY</span><span class="p">[</span><span class="n">system_prompt_path</span><span class="p">],</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>                <span class="n">model</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>                <span class="n">llm_provider</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_provider</span><span class="p">,</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>                <span class="n">api_type</span><span class="o">=</span><span class="n">api_type</span><span class="p">,</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>                <span class="n">model_args</span><span class="o">=</span><span class="n">model_config</span><span class="p">,</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>                <span class="n">log_base</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_base</span><span class="p">,</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>                <span class="n">max_exception_retry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_exception_retry&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>                <span class="n">max_interrupt_times</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_interrupt_times&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>                <span class="n">max_llm_recall</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_llm_recall&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>            <span class="p">)</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">__additional_args</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>        <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">)</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>            <span class="k">if</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">,</span> <span class="s1">&#39;**kwargs&#39;</span><span class="p">}:</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">__additional_args</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_st</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">st</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">StreamWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stream</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_base</span><span class="p">,</span> <span class="n">session_name</span><span class="p">)</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">restore_st</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>        <span class="k">pass</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">silent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">PrintSystem</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream_backup</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>        <span class="k">if</span> <span class="n">session_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>            <span class="n">session_name</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">set_st</span><span class="p">(</span><span class="n">session_name</span><span class="p">)</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>        <span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">st</span><span class="o">.</span><span class="n">expander</span><span class="p">(</span><span class="s1">&#39;Prediction Overview&#39;</span><span class="p">,</span> <span class="n">expanded</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">st</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">report</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">restore_st</span><span class="p">()</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>        <span class="k">return</span> <span class="n">report</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div><h2 id="dialog">Dialog</h2>


<div class="doc doc-object doc-class">



<h2 id="lllm.core.dialog.Dialog" class="doc doc-heading">
            <code>lllm.core.dialog.Dialog</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents first">



        <p>Whenever a dialog is created/forked, it should be associated with a session name</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>lllm/core/dialog.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-0-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-0-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">Dialog</span><span class="p">:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">    Whenever a dialog is created/forked, it should be associated with a session name</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="n">_messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Message</span><span class="p">]</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>    <span class="n">log_base</span><span class="p">:</span> <span class="n">ReplayableLogBase</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="n">session_name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="n">parent_dialog</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="n">top_prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Prompt</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dialog_id</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="n">dialogs_sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_base</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="n">RCollections</span><span class="o">.</span><span class="n">DIALOGS</span><span class="p">)</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_name</span><span class="p">)</span> <span class="c1"># track the dialogs created in this session</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="n">dialogs_sess</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dialog_id</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;parent_dialog&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_dialog</span><span class="p">})</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_base</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="n">RCollections</span><span class="o">.</span><span class="n">MESSAGES</span><span class="p">)</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session_name</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dialog_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># track the dialogs created in this session</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">):</span> <span class="c1"># ensure this is the only way to write the messages to make sure the trackability</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>        <span class="n">message</span><span class="o">.</span><span class="n">extra</span><span class="p">[</span><span class="s1">&#39;dialog_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialog_id</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span> <span class="c1"># Use to_dict for logging</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: Failed to log message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">, log the message without metadata&#39;</span><span class="p">)</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>            <span class="s1">&#39;messages&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">message</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_messages</span><span class="p">],</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>            <span class="s1">&#39;session_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_name</span><span class="p">,</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>            <span class="s1">&#39;parent_dialog&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_dialog</span><span class="p">,</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>            <span class="s1">&#39;top_prompt_path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_prompt</span><span class="o">.</span><span class="n">path</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_prompt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="p">}</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">log_base</span><span class="p">:</span> <span class="n">ReplayableLogBase</span><span class="p">,</span> <span class="n">prompt_registry</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Prompt</span><span class="p">]):</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="n">top_prompt_path</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;top_prompt_path&#39;</span><span class="p">]</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="k">if</span> <span class="n">top_prompt_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>            <span class="c1"># Assuming PROMPT_REGISTRY is available or passed. </span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>            <span class="c1"># For now, we rely on the passed prompt_registry.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>            <span class="n">top_prompt</span> <span class="o">=</span> <span class="n">prompt_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">top_prompt_path</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>            <span class="k">if</span> <span class="n">top_prompt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>                 <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Prompt </span><span class="si">{</span><span class="n">top_prompt_path</span><span class="si">}</span><span class="s2"> not found in registry.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>            <span class="n">top_prompt</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>            <span class="n">_messages</span><span class="o">=</span><span class="p">[</span><span class="n">Message</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;messages&#39;</span><span class="p">]],</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>            <span class="n">log_base</span><span class="o">=</span><span class="n">log_base</span><span class="p">,</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>            <span class="n">session_name</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;session_name&#39;</span><span class="p">],</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>            <span class="n">parent_dialog</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;parent_dialog&#39;</span><span class="p">],</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>            <span class="n">top_prompt</span><span class="o">=</span><span class="n">top_prompt</span><span class="p">,</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="p">)</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">messages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_messages</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">send_base64_image</span><span class="p">(</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="n">image_base64</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="n">caption</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="n">creator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="n">extra</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="n">role</span><span class="p">:</span> <span class="n">Roles</span> <span class="o">=</span> <span class="n">Roles</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="n">payload</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span> <span class="k">if</span> <span class="n">extra</span> <span class="k">else</span> <span class="p">{}</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="k">if</span> <span class="n">caption</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;caption&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">caption</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>            <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>            <span class="n">content</span><span class="o">=</span><span class="n">image_base64</span><span class="p">,</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>            <span class="n">creator</span><span class="o">=</span><span class="n">creator</span><span class="p">,</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>            <span class="n">modality</span><span class="o">=</span><span class="n">Modalities</span><span class="o">.</span><span class="n">IMAGE</span><span class="p">,</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>            <span class="n">extra</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="p">)</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="k">return</span> <span class="n">message</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">send_message</span><span class="p">(</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="n">prompt</span><span class="p">:</span> <span class="n">Prompt</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="n">prompt_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="n">creator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>  <span class="c1"># or &#39;user&#39;, etc.</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="n">extra</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="n">role</span><span class="p">:</span> <span class="n">Roles</span> <span class="o">=</span> <span class="n">Roles</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="n">prompt_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">prompt_args</span><span class="p">)</span> <span class="k">if</span> <span class="n">prompt_args</span> <span class="k">else</span> <span class="p">{}</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="n">metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span> <span class="k">if</span> <span class="n">extra</span> <span class="k">else</span> <span class="p">{}</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>            <span class="k">assert</span> <span class="ow">not</span> <span class="n">prompt_args</span><span class="p">,</span> <span class="s2">&quot;Prompt args are not allowed for string prompt&quot;</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="c1"># Create a temporary prompt object</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="n">prompt</span> <span class="o">=</span> <span class="n">Prompt</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;__temp_prompt_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())[:</span><span class="mi">6</span><span class="p">],</span> <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="n">content</span> <span class="o">=</span> <span class="n">prompt</span><span class="o">.</span><span class="n">prompt</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="k">elif</span> <span class="ow">not</span> <span class="n">prompt_args</span><span class="p">:</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="n">content</span> <span class="o">=</span> <span class="n">prompt</span><span class="o">.</span><span class="n">prompt</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="n">content</span> <span class="o">=</span> <span class="n">prompt</span><span class="p">(</span><span class="o">**</span><span class="n">prompt_args</span><span class="p">)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="n">message</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="n">role</span><span class="o">=</span><span class="n">role</span><span class="p">,</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="n">creator</span><span class="o">=</span><span class="n">creator</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="n">modality</span><span class="o">=</span><span class="n">Modalities</span><span class="o">.</span><span class="n">TEXT</span><span class="p">,</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="n">extra</span><span class="o">=</span><span class="n">metadata</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">top_prompt</span> <span class="o">=</span> <span class="n">prompt</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="k">return</span> <span class="n">message</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fork</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Dialog&#39;</span><span class="p">:</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="n">_messages</span> <span class="o">=</span> <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_messages</span><span class="p">]</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="n">_dialog</span> <span class="o">=</span> <span class="n">Dialog</span><span class="p">(</span><span class="n">_messages</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_base</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialog_id</span><span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="n">_dialog</span><span class="o">.</span><span class="n">top_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_prompt</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="k">return</span> <span class="n">_dialog</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">overview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remove_tail</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> 
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                 <span class="n">stream</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">divider</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="n">_overview</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">message</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="p">):</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>            <span class="k">if</span> <span class="n">remove_tail</span> <span class="ow">and</span> <span class="n">idx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                <span class="k">break</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>            <span class="c1"># message.overview() logic needs to be in Message class or here</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>            <span class="c1"># Message class has overview method in original code, I should add it back to Message model if I missed it</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>            <span class="c1"># I missed it in Message model. I&#39;ll implement a simple one here or add it to Message.</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>            <span class="c1"># Let&#39;s assume Message has it or I implement it here.</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="c1"># Implementing here for safety if I missed it in Pydantic model.</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>            <span class="n">content_preview</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)[:</span><span class="n">max_length</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">max_length</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>            <span class="n">_overview</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">. </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">creator</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s1">)]: </span><span class="si">{</span><span class="n">content_preview</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">&#39;</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="n">_overview</span> <span class="o">=</span> <span class="n">_overview</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="n">cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tail</span><span class="o">.</span><span class="n">cost</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">messages</span> <span class="k">else</span> <span class="n">CompletionCost</span><span class="p">()</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="k">if</span> <span class="n">stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="k">if</span> <span class="n">divider</span><span class="p">:</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                <span class="n">stream</span><span class="o">.</span><span class="n">divider</span><span class="p">()</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>            <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">html_collapse</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Context overview&#39;</span><span class="p">,</span> <span class="n">_overview</span><span class="p">),</span> <span class="n">unsafe_allow_html</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>            <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cost</span><span class="p">))</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="k">return</span> <span class="n">_overview</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1"># last message in the dialog, use it to get last response from the LLM</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_messages</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">system</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_messages</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">context_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Dialog&#39;</span><span class="p">:</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="n">_dialog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>            <span class="n">_dialog</span><span class="o">.</span><span class="n">_messages</span> <span class="o">=</span> <span class="n">_dialog</span><span class="o">.</span><span class="n">_messages</span><span class="p">[:</span><span class="o">-</span><span class="n">n</span><span class="p">]</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="k">return</span> <span class="n">_dialog</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cost</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CompletionCost</span><span class="p">:</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cost</span><span class="p">()</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CompletionCost</span><span class="p">:</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>        <span class="n">costs</span> <span class="o">=</span> <span class="p">[</span><span class="n">message</span><span class="o">.</span><span class="n">cost</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_messages</span><span class="p">]</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>        <span class="k">return</span> <span class="n">CompletionCost</span><span class="p">(</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>            <span class="n">prompt_tokens</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">cost</span><span class="o">.</span><span class="n">prompt_tokens</span> <span class="k">for</span> <span class="n">cost</span> <span class="ow">in</span> <span class="n">costs</span><span class="p">]),</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>            <span class="n">completion_tokens</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">cost</span><span class="o">.</span><span class="n">completion_tokens</span> <span class="k">for</span> <span class="n">cost</span> <span class="ow">in</span> <span class="n">costs</span><span class="p">]),</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>            <span class="n">cached_prompt_tokens</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">cost</span><span class="o">.</span><span class="n">cached_prompt_tokens</span> <span class="k">for</span> <span class="n">cost</span> <span class="ow">in</span> <span class="n">costs</span><span class="p">]),</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>            <span class="n">cost</span><span class="o">=</span><span class="nb">sum</span><span class="p">([</span><span class="n">cost</span><span class="o">.</span><span class="n">cost</span> <span class="k">for</span> <span class="n">cost</span> <span class="ow">in</span> <span class="n">costs</span><span class="p">])</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div><h2 id="models">Models</h2>


<div class="doc doc-object doc-class">



<h2 id="lllm.core.models.Message" class="doc doc-heading">
            <code>lllm.core.models.Message</code>


</h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code></p>










              <details class="mkdocstrings-source">
                <summary>Source code in <code>lllm/core/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="k">class</span><span class="w"> </span><span class="nc">Message</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="n">role</span><span class="p">:</span> <span class="n">Roles</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>    <span class="n">content</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="c1"># Content can be string or list of content parts (for images)</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="n">creator</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="n">raw_response</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>    <span class="n">function_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionCall</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>    <span class="n">modality</span><span class="p">:</span> <span class="n">Modalities</span> <span class="o">=</span> <span class="n">Modalities</span><span class="o">.</span><span class="n">TEXT</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="n">logprobs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TokenLogprob</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>    <span class="n">parsed</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>    <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>    <span class="n">usage</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="n">model_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>    <span class="n">extra</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>    <span class="n">execution_errors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="ne">Exception</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>    <span class="n">execution_attempts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s1">&#39;Message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>    <span class="n">api_type</span><span class="p">:</span> <span class="n">APITypes</span> <span class="o">=</span> <span class="n">APITypes</span><span class="o">.</span><span class="n">COMPLETION</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">arbitrary_types_allowed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;logprobs&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_coerce_logprobs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>            <span class="k">return</span> <span class="p">[]</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>        <span class="n">normalized</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TokenLogprob</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">TokenLogprob</span><span class="p">):</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                <span class="n">normalized</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                <span class="k">continue</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>                <span class="n">normalized</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TokenLogprob</span><span class="p">(</span><span class="o">**</span><span class="n">entry</span><span class="p">))</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>                <span class="k">continue</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>                <span class="n">normalized</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TokenLogprob</span><span class="p">(</span><span class="n">logprob</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">entry</span><span class="p">)))</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>                <span class="k">continue</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>            <span class="n">normalized</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TokenLogprob</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">entry</span><span class="p">)))</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="k">return</span> <span class="n">normalized</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">error_message</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_errors</span><span class="p">])</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">cost</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CompletionCost</span><span class="p">:</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">usage</span><span class="p">:</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>            <span class="k">return</span> <span class="n">CompletionCost</span><span class="p">()</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>            <span class="n">card</span> <span class="o">=</span> <span class="n">find_model_card</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>            <span class="k">return</span> <span class="n">CompletionCost</span><span class="p">()</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>        <span class="k">return</span> <span class="n">card</span><span class="o">.</span><span class="n">cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">usage</span><span class="p">)</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_function_call</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_calls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;raw_response&#39;</span><span class="p">,</span> <span class="s1">&#39;execution_errors&#39;</span><span class="p">,</span> <span class="s1">&#39;execution_attempts&#39;</span><span class="p">})</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="lllm.core.models.Prompt" class="doc doc-heading">
            <code>lllm.core.models.Prompt</code>


</h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code></p>










              <details class="mkdocstrings-source">
                <summary>Source code in <code>lllm/core/models.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="k">class</span><span class="w"> </span><span class="nc">Prompt</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>    <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>    <span class="n">functions_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Function</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>    <span class="n">mcp_servers_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MCP</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>    <span class="n">parser</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>    <span class="n">exception_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Error: </span><span class="si">{error_message}</span><span class="s2">. Please fix.&quot;</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>    <span class="n">interrupt_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Result: </span><span class="si">{call_results}</span><span class="s2">. Continue?&quot;</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>    <span class="n">interrupt_final_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;All tool calls are done. Provide the final response.&quot;</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>    <span class="nb">format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Pydantic model class for structured output</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>    <span class="n">xml_tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>    <span class="n">md_tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>    <span class="n">signal_tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>    <span class="n">required_xml_tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>    <span class="n">required_md_tags</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>    <span class="n">allow_web_search</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>    <span class="n">computer_use_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>    <span class="n">functions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Function</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>    <span class="n">mcp_servers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">MCP</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">arbitrary_types_allowed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">model_post_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__context</span><span class="p">):</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">functions</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">functions_list</span><span class="p">}</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mcp_servers</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="o">.</span><span class="n">server_label</span><span class="p">:</span> <span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcp_servers_list</span><span class="p">}</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">link_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">functions</span><span class="p">:</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">link_function</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">register_mcp_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">:</span> <span class="n">MCP</span><span class="p">):</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mcp_servers</span><span class="p">[</span><span class="n">server</span><span class="o">.</span><span class="n">server_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">server</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">exception_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>        <span class="c1"># Recursive prompt creation logic (simplified for now)</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>        <span class="k">return</span> <span class="n">Prompt</span><span class="p">(</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>            <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;__</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s1">_exception_handler&#39;</span><span class="p">,</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>            <span class="n">prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exception_prompt</span><span class="p">,</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>            <span class="n">parser</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="p">,</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>            <span class="n">functions_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">functions_list</span><span class="p">,</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>            <span class="n">mcp_servers_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mcp_servers_list</span><span class="p">,</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>            <span class="n">exception_prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exception_prompt</span><span class="p">,</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>            <span class="n">interrupt_prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interrupt_prompt</span><span class="p">,</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>            <span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">,</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>            <span class="n">xml_tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xml_tags</span><span class="p">,</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>            <span class="n">md_tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">md_tags</span><span class="p">,</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>            <span class="n">signal_tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">signal_tags</span><span class="p">,</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>            <span class="n">required_xml_tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">required_xml_tags</span><span class="p">,</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>            <span class="n">required_md_tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">required_md_tags</span><span class="p">,</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>            <span class="n">allow_web_search</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_web_search</span><span class="p">,</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>            <span class="n">computer_use_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">computer_use_config</span><span class="p">,</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>            <span class="n">interrupt_final_prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interrupt_final_prompt</span><span class="p">,</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>        <span class="p">)</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">interrupt_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>         <span class="k">return</span> <span class="n">Prompt</span><span class="p">(</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>            <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;__</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s1">_interrupt_handler&#39;</span><span class="p">,</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>            <span class="n">prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interrupt_prompt</span><span class="p">,</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>            <span class="n">parser</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="p">,</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>            <span class="n">functions_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">functions_list</span><span class="p">,</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>            <span class="n">mcp_servers_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mcp_servers_list</span><span class="p">,</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>            <span class="n">exception_prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exception_prompt</span><span class="p">,</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>            <span class="n">interrupt_prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interrupt_prompt</span><span class="p">,</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>            <span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">,</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>            <span class="n">xml_tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xml_tags</span><span class="p">,</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>            <span class="n">md_tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">md_tags</span><span class="p">,</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>            <span class="n">signal_tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">signal_tags</span><span class="p">,</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>            <span class="n">required_xml_tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">required_xml_tags</span><span class="p">,</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>            <span class="n">required_md_tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">required_md_tags</span><span class="p">,</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>            <span class="n">allow_web_search</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_web_search</span><span class="p">,</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>            <span class="n">computer_use_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">computer_use_config</span><span class="p">,</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>            <span class="n">interrupt_final_prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interrupt_final_prompt</span><span class="p">,</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="p">)</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>    <span class="nd">@property</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">interrupt_handler_final</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>         <span class="k">return</span> <span class="n">Prompt</span><span class="p">(</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>            <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;__</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s1">_interrupt_handler_final&#39;</span><span class="p">,</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>            <span class="n">prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interrupt_final_prompt</span><span class="p">,</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>            <span class="n">parser</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="p">,</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>            <span class="n">functions_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">functions_list</span><span class="p">,</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>            <span class="n">mcp_servers_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mcp_servers_list</span><span class="p">,</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>            <span class="n">exception_prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exception_prompt</span><span class="p">,</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>            <span class="n">interrupt_prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interrupt_prompt</span><span class="p">,</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>            <span class="n">interrupt_final_prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interrupt_final_prompt</span><span class="p">,</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>            <span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">,</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>            <span class="n">xml_tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xml_tags</span><span class="p">,</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>            <span class="n">md_tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">md_tags</span><span class="p">,</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>            <span class="n">signal_tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">signal_tags</span><span class="p">,</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>            <span class="n">required_xml_tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">required_xml_tags</span><span class="p">,</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>            <span class="n">required_md_tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">required_md_tags</span><span class="p">,</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>            <span class="n">allow_web_search</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_web_search</span><span class="p">,</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>            <span class="n">computer_use_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">computer_use_config</span><span class="p">,</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.sections", "navigation.expand", "content.code.copy"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>